<app-breadcrumb [segments]="breadcrumbSegments" />

@if (company()) {
  <app-company-header
    [company]="company()!"
    titleSuffix=" — Graham Score"
    [links]="headerLinks()" />
}

@if (loading()) {
  <p>Loading scoring data...</p>
} @else if (error()) {
  <p class="error">{{ error() }}</p>
} @else if (scoring()) {
  <div class="score-summary" [class]="scoreBadgeClass()">
    <span class="score-value">{{ scoring()!.overallScore }}</span>
    <span class="score-sep">/</span>
    <span class="score-total">{{ scoring()!.computableChecks }}</span>
  </div>
  <p class="score-caption">
    {{ scoring()!.yearsOfData }} year{{ scoring()!.yearsOfData === 1 ? '' : 's' }} of data
    @if (scoring()!.pricePerShare != null) {
      &middot; Price: \${{ scoring()!.pricePerShare! | number:'1.2-2' }}
      @if (scoring()!.priceDate) {
        ({{ scoring()!.priceDate }})
      }
    }
    @if (scoring()!.sharesOutstanding != null) {
      &middot; Shares: {{ scoring()!.sharesOutstanding! | number:'1.0-0' }}
    }
  </p>

  <div class="scorecard-layout">
    <div>
      <h3>Scorecard</h3>
      <table class="scorecard-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Check</th>
            <th>Value</th>
            <th>Threshold</th>
            <th class="result-cell">Result</th>
          </tr>
        </thead>
        <tbody>
          @for (check of scoring()!.scorecard; track check.checkNumber) {
            <tr [class]="'check-' + check.result">
              <td>{{ check.checkNumber }}</td>
              <td>{{ check.name }}</td>
              <td class="num">{{ formatValue(check.computedValue, check.threshold) }}</td>
              <td>{{ check.threshold }}</td>
              <td class="result-cell">
                @if (check.result === 'pass') {
                  <span class="indicator pass">&#10003;</span>
                } @else if (check.result === 'fail') {
                  <span class="indicator fail">&#10007;</span>
                } @else {
                  <span class="indicator na">&mdash;</span>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    <div>
      <h3>Derived Metrics</h3>
      <table class="metrics-table">
        <thead>
          <tr>
            <th>Metric</th>
            <th class="num">Value</th>
          </tr>
        </thead>
        <tbody>
          @for (m of metricRows(); track m.label) {
            <tr>
              <td>{{ m.label }}</td>
              <td class="num">{{ m.display }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <div class="trends-grid">
    @if (arRevenueRows().length > 0) {
      <div class="trend-cell">
        <h3>AR / Revenue Trend <span class="info-icon" data-tooltip="Accounts Receivable as a percentage of Revenue. Rising AR/Revenue may indicate customers are slower to pay or aggressive revenue recognition.">&#9432;</span></h3>
        <div class="ar-revenue-content">
          <table class="ar-revenue-table">
            <thead>
              <tr>
                <th>Year</th>
                <th class="num">AR</th>
                <th class="num">Revenue</th>
                <th class="num">AR / Revenue</th>
              </tr>
            </thead>
            <tbody>
              @for (row of arRevenueRows(); track row.year) {
                <tr>
                  <td>{{ row.year }}</td>
                  <td class="num">{{ row.accountsReceivable != null ? formatAbbrev(row.accountsReceivable) : '—' }}</td>
                  <td class="num">{{ row.revenue != null ? formatAbbrev(row.revenue) : '—' }}</td>
                  <td class="num">{{ row.ratio != null ? formatArPct(row.ratio) : '—' }}</td>
                </tr>
              }
            </tbody>
          </table>
          <app-sparkline-chart [data]="sparklineData()" [formatTooltip]="formatArPctTooltip" />
        </div>
      </div>
    }

    @if (workingCapital()) {
      <div class="trend-cell">
        <h3>{{ workingCapital()!.label }} Trend <span class="info-icon" [attr.data-tooltip]="workingCapital()!.tooltip">&#9432;</span></h3>
        <div class="ar-revenue-content">
          <table class="ar-revenue-table">
            <thead>
              <tr>
                <th>Year</th>
                <th class="num">{{ workingCapital()!.label }}</th>
              </tr>
            </thead>
            <tbody>
              @for (row of workingCapital()!.rows; track row.year) {
                <tr>
                  <td>{{ row.year }}</td>
                  <td class="num">{{ row.display }}</td>
                </tr>
              }
            </tbody>
          </table>
          <app-sparkline-chart [data]="workingCapital()!.sparkline" [formatTooltip]="formatAbbrevTooltip" />
        </div>
      </div>
    }
  </div>

  @if (yearKeys().length > 0) {
    <h3>Raw Data</h3>
    <table class="raw-table">
      <thead>
        <tr>
          <th>Concept</th>
          @for (yr of yearKeys(); track yr) {
            <th class="num">{{ yr }}</th>
          }
        </tr>
      </thead>
      <tbody>
        @for (row of rawRows(); track row.concept) {
          <tr>
            <td>{{ row.concept }}</td>
            @for (yr of yearKeys(); track yr) {
              <td class="num">{{ row.values[yr] != null ? (row.values[yr]! | number:'1.0-0') : '' }}</td>
            }
          </tr>
        }
      </tbody>
    </table>
  }
}